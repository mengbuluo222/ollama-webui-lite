import{s as ge,b as T,k as O,h as L,o as fe,t as ne}from"../chunks/scheduler.073150aa.js";import{S as _e,i as he,G as k,r as F,s as ae,g as V,u as q,c as le,h as G,j as Y,f as N,k as z,v as K,a as ce,x as U,A as we,d as Q,t as W,w as X}from"../chunks/index.fc5233d8.js";import{N as ye,M as be,a as Se,b as ve,g as Ie}from"../chunks/Navbar.591d29ba.js";import{t as P}from"../chunks/Toaster.svelte_svelte_type_style_lang.44440a81.js";import{e as re,v as ie,s as pe,b as Ce,O as ue,a as Me,d as Te}from"../chunks/_commonjsHelpers.0f22a02e.js";import{p as Oe}from"../chunks/stores.6147508c.js";const{window:ke}=Ie;function Ne(n){let b,s,d,g,o,_,v,h,m,p,S,l,a,R,y,I,E,C,J,D;b=new ye({props:{title:n[3]}});function Z(e){n[11](e)}let j={disabled:n[5].length>0};n[2]!==void 0&&(j.selectedModels=n[2]),_=new be({props:j}),T.push(()=>k(_,"selectedModels",Z));function x(e){n[12](e)}function $(e){n[13](e)}function ee(e){n[14](e)}let M={selectedModels:n[2],sendPrompt:n[6],regenerateResponse:n[9]};n[0]!==void 0&&(M.history=n[0]),n[5]!==void 0&&(M.messages=n[5]),n[1]!==void 0&&(M.autoScroll=n[1]),p=new Se({props:M}),T.push(()=>k(p,"history",x)),T.push(()=>k(p,"messages",$)),T.push(()=>k(p,"autoScroll",ee));function te(e){n[15](e)}function se(e){n[16](e)}let A={messages:n[5],submitPrompt:n[7],stopResponse:n[8]};return n[4]!==void 0&&(A.prompt=n[4]),n[1]!==void 0&&(A.autoScroll=n[1]),y=new ve({props:A}),T.push(()=>k(y,"prompt",te)),T.push(()=>k(y,"autoScroll",se)),{c(){F(b.$$.fragment),s=ae(),d=V("div"),g=V("div"),o=V("div"),F(_.$$.fragment),h=ae(),m=V("div"),F(p.$$.fragment),R=ae(),F(y.$$.fragment),this.h()},l(e){q(b.$$.fragment,e),s=le(e),d=G(e,"DIV",{class:!0});var t=Y(d);g=G(t,"DIV",{class:!0});var r=Y(g);o=G(r,"DIV",{class:!0});var i=Y(o);q(_.$$.fragment,i),i.forEach(N),h=le(r),m=G(r,"DIV",{class:!0});var u=Y(m);q(p.$$.fragment,u),u.forEach(N),r.forEach(N),R=le(t),q(y.$$.fragment,t),t.forEach(N),this.h()},h(){z(o,"class","max-w-2xl mx-auto w-full px-3 md:px-0 mt-10"),z(m,"class","h-full mt-10 mb-32 w-full flex flex-col"),z(g,"class","py-2.5 flex flex-col justify-between w-full"),z(d,"class","min-h-screen w-full flex justify-center")},m(e,t){K(b,e,t),ce(e,s,t),ce(e,d,t),U(d,g),U(g,o),K(_,o,null),U(g,h),U(g,m),K(p,m,null),U(d,R),K(y,d,null),C=!0,J||(D=we(ke,"scroll",n[10]),J=!0)},p(e,[t]){const r={};t&8&&(r.title=e[3]),b.$set(r);const i={};t&32&&(i.disabled=e[5].length>0),!v&&t&4&&(v=!0,i.selectedModels=e[2],O(()=>v=!1)),_.$set(i);const u={};t&4&&(u.selectedModels=e[2]),!S&&t&1&&(S=!0,u.history=e[0],O(()=>S=!1)),!l&&t&32&&(l=!0,u.messages=e[5],O(()=>l=!1)),!a&&t&2&&(a=!0,u.autoScroll=e[1],O(()=>a=!1)),p.$set(u);const c={};t&32&&(c.messages=e[5]),!I&&t&16&&(I=!0,c.prompt=e[4],O(()=>I=!1)),!E&&t&2&&(E=!0,c.autoScroll=e[1],O(()=>E=!1)),y.$set(c)},i(e){C||(Q(b.$$.fragment,e),Q(_.$$.fragment,e),Q(p.$$.fragment,e),Q(y.$$.fragment,e),C=!0)},o(e){W(b.$$.fragment,e),W(_.$$.fragment,e),W(p.$$.fragment,e),W(y.$$.fragment,e),C=!1},d(e){e&&(N(s),N(d)),X(b,e),X(_),X(p),X(y),J=!1,D()}}}function Pe(n,b,s){let d,g,o,_;L(n,re,e=>s(18,d=e)),L(n,Te,e=>s(19,g=e)),L(n,pe,e=>s(20,o=e)),L(n,Oe,e=>s(21,_=e));let v=!1,h=!0,m=[""],p="",S="",l=[],a={messages:{},currentId:null};fe(async()=>{await re.set(ie()),re.subscribe(async()=>{await R()})});const R=async()=>{var t;console.log(d),s(1,h=!0),s(3,p=""),s(5,l=[]),s(0,a={messages:{},currentId:null}),s(2,m=_.url.searchParams.get("models")?(t=_.url.searchParams.get("models"))==null?void 0:t.split(","):o.models??[""]);let e=JSON.parse(localStorage.getItem("settings")??"{}");console.log(e),pe.set({...e})},y=e=>{if(!navigator.clipboard){var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{var r=document.execCommand("copy"),i=r?"successful":"unsuccessful";console.log("Fallback: Copying text command was "+i)}catch(u){console.error("Fallback: Oops, unable to copy",u)}document.body.removeChild(t);return}navigator.clipboard.writeText(e).then(function(){console.log("Async: Copying to clipboard was successful!")},function(u){console.error("Async: Could not copy text: ",u)})},I=async(e,t,r)=>{await Promise.all(m.map(async i=>{await E(i,e,t,r)})),await Ce.set(await g.getChats())},E=async(e,t,r,i)=>{console.log("sendPromptOllama");let u=ie(),c={parentId:r,id:u,childrenIds:[],role:"assistant",content:"",model:e};s(0,a.messages[u]=c,a),s(0,a.currentId=u,a),r!==null&&s(0,a.messages[r].childrenIds=[...a.messages[r].childrenIds,u],a),await ne(),window.scrollTo({top:document.body.scrollHeight});const B=await fetch(`${(o==null?void 0:o.API_BASE_URL)??ue}/chat`,{method:"POST",headers:{"Content-Type":"text/event-stream"},body:JSON.stringify({model:e,messages:l.map(w=>({role:w.role,content:w.content})),options:{seed:o.seed??void 0,temperature:o.temperature??void 0,repeat_penalty:o.repeat_penalty??void 0,top_k:o.top_k??void 0,top_p:o.top_p??void 0,num_ctx:o.num_ctx??void 0,...o.options??{}},format:o.requestFormat??void 0})}).catch(w=>(console.log(w),null));if(B&&B.ok){const w=B.body.pipeThrough(new TextDecoderStream).pipeThrough(Me(`
`)).getReader();for(;;){const{value:de,done:me}=await w.read();if(me||v||i!==d){c.done=!0,s(5,l),s(0,a);break}try{let H=de.split(`
`);for(const oe of H)if(oe!==""){console.log(oe);let f=JSON.parse(oe);if("detail"in f)throw f;if(f.done==!1){if(c.content==""&&f.message.content==`
`)continue;c.content+=f.message.content,s(5,l),s(0,a)}else c.done=!0,c.context=f.context??null,c.info={total_duration:f.total_duration,load_duration:f.load_duration,sample_count:f.sample_count,sample_duration:f.sample_duration,prompt_eval_count:f.prompt_eval_count,prompt_eval_duration:f.prompt_eval_duration,eval_count:f.eval_count,eval_duration:f.eval_duration},s(5,l),s(0,a),o.responseAutoCopy&&y(c.content)}}catch(H){console.log(H),"detail"in H&&P.error(H.detail);break}h&&window.scrollTo({top:document.body.scrollHeight}),await g.updateChatById(i,{title:p===""?"New Chat":p,models:m,options:{seed:o.seed??void 0,temperature:o.temperature??void 0,repeat_penalty:o.repeat_penalty??void 0,top_k:o.top_k??void 0,top_p:o.top_p??void 0,num_ctx:o.num_ctx??void 0,...o.options??{}},messages:l,history:a})}}else{if(B!==null){const w=await B.json();console.log(w),"detail"in w?(P.error(w.detail),c.content=w.detail):(P.error(w.error),c.content=w.error)}else P.error("Uh-oh! There was an issue connecting to Ollama."),c.content="Uh-oh! There was an issue connecting to Ollama.";c.error=!0,c.content="Uh-oh! There was an issue connecting to Ollama.",c.done=!0,s(5,l),s(0,a)}v=!1,await ne(),h&&window.scrollTo({top:document.body.scrollHeight}),l.length==2&&l.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${i}`),await Z(i,t))},C=async e=>{const t=JSON.parse(JSON.stringify(d));if(console.log("submitPrompt",t),m.includes(""))P.error("Model not selected");else if(l.length!=0&&l.at(-1).done!=!0)console.log("wait");else{document.getElementById("chat-textarea").style.height="";let r=ie(),i={id:r,parentId:l.length!==0?l.at(-1).id:null,childrenIds:[],role:"user",content:e};l.length!==0&&a.messages[l.at(-1).id].childrenIds.push(r),s(0,a.messages[r]=i,a),s(0,a.currentId=r,a),await ne(),l.length==1&&await g.createNewChat({id:t,title:"New Chat",models:m,options:{seed:o.seed??void 0,temperature:o.temperature??void 0,repeat_penalty:o.repeat_penalty??void 0,top_k:o.top_k??void 0,top_p:o.top_p??void 0,num_ctx:o.num_ctx??void 0,...o.options??{}},messages:l,history:a}),s(4,S=""),setTimeout(()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},50),await I(e,r,t)}},J=()=>{v=!0,console.log("stopResponse")},D=async()=>{const e=JSON.parse(JSON.stringify(d));if(console.log("regenerateResponse",e),l.length!=0&&l.at(-1).done==!0){l.splice(l.length-1,1),s(5,l),s(0,a);let t=l.at(-1),r=t.content;await I(r,t.id,e)}},Z=async(e,t)=>{if(o.titleAutoGenerate??!0){console.log("generateChatTitle");const r=await fetch(`${(o==null?void 0:o.API_BASE_URL)??ue}/generate`,{method:"POST",headers:{"Content-Type":"text/event-stream"},body:JSON.stringify({model:m[0],prompt:`Generate a brief 3-5 word title for this question, excluding the term 'title.' Then, please reply with only the title: ${t}`,stream:!1})}).then(async i=>{if(!i.ok)throw await i.json();return i.json()}).catch(i=>("detail"in i&&P.error(i.detail),console.log(i),null));r&&await j(e,r.response===""?"New Chat":r.response)}else await j(e,`${t}`)},j=async(e,t)=>{await g.updateChatById(e,{title:t}),e===d&&s(3,p=t)},x=e=>{s(1,h=window.innerHeight+window.scrollY>=document.body.offsetHeight-40)};function $(e){m=e,s(2,m)}function ee(e){a=e,s(0,a)}function M(e){l=e,s(5,l),s(0,a)}function te(e){h=e,s(1,h)}function se(e){S=e,s(4,S)}function A(e){h=e,s(1,h)}return n.$$.update=()=>{if(n.$$.dirty&1)if(a.currentId!==null){let e=[],t=a.messages[a.currentId];for(;t!==null;)e.unshift({...t}),t=t.parentId!==null?a.messages[t.parentId]:null;s(5,l=e)}else s(5,l=[])},[a,h,m,p,S,l,I,C,J,D,x,$,ee,M,te,se,A]}class He extends _e{constructor(b){super(),he(this,b,Pe,Ne,ge,{})}}export{He as component};
